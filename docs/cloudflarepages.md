# Cloudflare Pages Implementation Guide

**Project:** CaroHans Ventures ERMS
**Target Platform:** Cloudflare Pages
**Runtime:** Cloudflare Edge Runtime

This document details the configuration and workflows used to deploy the Next.js application to Cloudflare Pages using the `@cloudflare/next-on-pages` adapter.

---

## 1. Architecture Overview

The application uses the **Next.js App Router**. To run on Cloudflare's global edge network, we utilize `@cloudflare/next-on-pages`. This utility:
1.  Builds the Next.js application.
2.  Transforms the build output into a format compatible with Cloudflare Workers/Pages (specifically the `_worker.js` script and static assets).
3.  Outputs the result to `.vercel/output/static`, which aligns with the Vercel Build Output API standard that Cloudflare supports.

---

## 2. Configuration

### 2.1 `wrangler.toml` (Root)
This file governs the Cloudflare Pages configuration. It points Wrangler to the correct output directory generated by the build process.

```toml
name = "carohans"
compatibility_date = "2024-09-23"
pages_build_output_dir = "apps/web/.vercel/output/static"
```

### 2.2 `apps/web/next.config.ts`
Standard Next.js configuration is maintained. No special `output` mode (like `export`) is required because `@cloudflare/next-on-pages` handles the adaptation. Note that `experimental.turbopack` is **not** supported in production builds and will cause errors.

```typescript
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  transpilePackages: [],
};

export default nextConfig;
```

---

## 3. Environment Variables

The deployment pipeline is managed via `pnpm` and `turbo` scripts defined in the root and workspace `package.json` files.

### Root `package.json`
| Command | Script | Description |
| :--- | :--- | :--- |
| **Build** | `pnpm build:pages` | Runs `turbo run pages:build`. This triggers the specific adapter build in the `web` app. |
| **Deploy** | `pnpm deploy` | Echoes a message. Deployment is handled automatically by Cloudflare Pages after the build. |

### `apps/web/package.json`
| Command | Script | Description |
| :--- | :--- | :--- |
| **Adapter Build** | `pnpm pages:build` | Executes `next-on-pages --skip-build`. This uses the artifacts from the previous standard build step, avoiding redundant builds and potential issues. |

---

## 4. Deployment Workflow

### 4.1 Manual Deployment (CLI)
While the `deploy` script is a no-op for CI/CD, you can still manually deploy using Wrangler from your terminal if you have the necessary permissions:

1.  **Build the Project:**
    ```bash
    pnpm build:pages
    ```
2.  **Deploy to Cloudflare:**
    ```bash
    npx wrangler pages deploy apps/web/.vercel/output/static
    ```

### 4.2 CI/CD (Git Integration)
When connecting the repository directly to Cloudflare Pages via the dashboard:

1.  **Build Command:** `pnpm build:pages`
2.  **Deploy Command:** `pnpm deploy`
3.  **Build Output Directory:** `apps/web/.vercel/output/static`
4.  **Root Directory:** `/` (Leave as default)
4.  **Environment Variables:** Add any required keys (e.g., `NEXT_PUBLIC_...`) in the Cloudflare Pages settings.

---

## 5. Runtime Considerations

Since the application runs on the **Edge Runtime**, standard Node.js APIs (like `fs`) are **not available**.
*   **Edge Compatibility:** Ensure all libraries used in server components or API routes are edge-compatible.
*   **Database Access:** If a database is added later, use HTTP-based drivers (e.g., Neon, Turso) or Cloudflare D1, as direct TCP connections are generally not supported in the standard Edge runtime without specific adapters.

---

## 6. Troubleshooting

### 6.1 Build Errors: Monorepo Resolution
**Error:** `Next.js inferred your workspace root, but it may not be correct.`

**Cause:** The `next-on-pages` command triggers a secondary build which may default to using Turbopack or fail to resolve the monorepo root correctly.

**Fix:** Use the `--skip-build` flag to prevent `next-on-pages` from rebuilding the application. Instead, rely on the standard `next build` that runs before it.

Update `apps/web/package.json`:
```json
"scripts": {
  "build": "next build",
  "pages:build": "next-on-pages --skip-build"
}
```

### 6.2 Module Resolution: `fs` or `path`
**Error:** `Module not found: Can't resolve 'fs'`

**Cause:** Standard Node.js modules are not available in the Edge Runtime.

**Fix:** Ensure you are using edge-compatible libraries. If a library optionally uses `fs`, you may need to configure your bundler to ignore it or use a polyfill that returns empty/null.

### 6.3 Local Testing
To verify edge compatibility before pushing to Cloudflare:
```bash
pnpm build:pages
npx wrangler pages dev apps/web/.vercel/output/static
```
